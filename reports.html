<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Reports - ExpenseEase</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
  /* Reset & Base Styles */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  body {
    font-family: 'Montserrat', sans-serif;
    background-color: #f0f4f8;
    color: #333;
    line-height: 1.6;
    padding: 20px;
    min-height: 100vh;
  }

  /* Header */
  .header {
    background-color: #4CAF50;
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .logo {
    font-size: 1.5em;
    font-weight: 700;
    color: #fff;
    letter-spacing: 1px;
  }
  .user-info {
    color: #fff;
    font-weight: 500;
  }
  .logout-btn {
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s;
  }
  .logout-btn:hover {
    background: rgba(255,255,255,0.3);
  }

  /* Page Title */
  .page-title {
    color: #4CAF50;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .page-title h2 {
    font-size: 1.8em;
  }

  /* Controls */
  .controls {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: end;
  }
  .control-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
  }
  .control-group label {
    font-weight: 600;
    margin-bottom: 5px;
    color: #555;
  }
  .control-group select, .control-group input {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-family: 'Montserrat', sans-serif;
  }
  .btn {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s;
  }
  .btn:hover {
    background-color: #45a049;
  }
  .btn-secondary {
    background-color: #6c757d;
  }
  .btn-secondary:hover {
    background-color: #5a6268;
  }

  /* Stats Cards */
  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }
  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    text-align: center;
  }
  .stat-value {
    font-size: 1.8em;
    font-weight: 700;
    margin: 10px 0;
  }
  .stat-label {
    color: #666;
    font-weight: 500;
  }
  .stat-total { border-top: 4px solid #4CAF50; }
  .stat-approved { border-top: 4px solid #28a745; }
  .stat-pending { border-top: 4px solid #ffc107; }
  .stat-declined { border-top: 4px solid #dc3545; }

  /* Charts */
  .charts-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }
  .chart-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  .chart-title {
    margin-bottom: 15px;
    color: #4CAF50;
    font-weight: 600;
  }
  .chart {
    height: 250px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border-radius: 5px;
    margin-bottom: 10px;
  }
  .chart-placeholder {
    color: #6c757d;
    text-align: center;
  }

  /* Tables */
  .table-container {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 12px 15px;
    text-align: left;
  }
  th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #495057;
  }
  tr:nth-child(even) {
    background-color: #f8f9fa;
  }
  .status-badge {
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
  }
  .status-pending {
    background-color: #fff3cd;
    color: #856404;
  }
  .status-approved {
    background-color: #d4edda;
    color: #155724;
  }
  .status-declined {
    background-color: #f8d7da;
    color: #721c24;
  }

  /* Export Section */
  .export-section {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  .export-options {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }

  /* Tabs */
  .tabs {
    display: flex;
    margin-bottom: 20px;
    border-bottom: 1px solid #ddd;
  }
  .tab {
    padding: 10px 20px;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    font-weight: 500;
  }
  .tab.active {
    border-bottom: 3px solid #4CAF50;
    font-weight: 600;
    color: #4CAF50;
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
  }
  .empty-state i {
    font-size: 3em;
    margin-bottom: 15px;
    opacity: 0.5;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .charts-container {
      grid-template-columns: 1fr;
    }
    .controls {
      flex-direction: column;
      align-items: stretch;
    }
    .control-group {
      width: 100%;
    }
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="logo">ExpenseEase Reports</div>
  <div class="user-info">
    <span id="userDisplay">Welcome, User</span>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</div>

<!-- Page Title -->
<div class="page-title">
  <h2>Expense Reports & Analytics</h2>
  <div id="reportPeriod">Loading...</div>
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tab active" onclick="switchTab('overview')">Overview</div>
  <div class="tab" onclick="switchTab('expenses')">Expenses</div>
  <div class="tab" onclick="switchTab('requests')">Requests</div>
  <div class="tab" id="adminTab" style="display:none;" onclick="switchTab('admin')">Admin Reports</div>
</div>

<!-- Overview Tab -->
<div id="overview" class="tab-content active">
  <!-- Controls -->
  <div class="controls">
    <div class="control-group">
      <label for="timeRange">Time Range</label>
      <select id="timeRange">
        <option value="7">Last 7 Days</option>
        <option value="30" selected>Last 30 Days</option>
        <option value="90">Last 90 Days</option>
        <option value="365">Last Year</option>
        <option value="custom">Custom Range</option>
      </select>
    </div>
    <div class="control-group" id="customRangeGroup" style="display:none;">
      <label for="startDate">Start Date</label>
      <input type="date" id="startDate">
    </div>
    <div class="control-group" id="customRangeGroup2" style="display:none;">
      <label for="endDate">End Date</label>
      <input type="date" id="endDate">
    </div>
    <div class="control-group">
      <label for="categoryFilter">Category</label>
      <select id="categoryFilter">
        <option value="all">All Categories</option>
        <option value="Travel">Travel</option>
        <option value="Meals">Meals</option>
        <option value="Equipment">Equipment</option>
        <option value="Training">Training</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="control-group" id="employeeFilterGroup" style="display:none;">
      <label for="employeeFilter">Employee</label>
      <select id="employeeFilter">
        <option value="all">All Employees</option>
      </select>
    </div>
    <button class="btn" onclick="generateReport()">Generate Report</button>
    <button class="btn btn-secondary" onclick="resetFilters()">Reset Filters</button>
  </div>

  <!-- Stats Cards -->
  <div class="stats-container">
    <div class="stat-card stat-total">
      <div class="stat-label">Total Expenses</div>
      <div class="stat-value" id="totalExpenses">$0.00</div>
      <div>Across all categories</div>
    </div>
    <div class="stat-card stat-approved">
      <div class="stat-label">Approved Requests</div>
      <div class="stat-value" id="approvedRequests">0</div>
      <div>Fully processed</div>
    </div>
    <div class="stat-card stat-pending">
      <div class="stat-label">Pending Requests</div>
      <div class="stat-value" id="pendingRequests">0</div>
      <div>Awaiting approval</div>
    </div>
    <div class="stat-card stat-declined">
      <div class="stat-label">Declined Requests</div>
      <div class="stat-value" id="declinedRequests">0</div>
      <div>Not approved</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts-container">
    <div class="chart-card">
      <div class="chart-title">Expenses by Category</div>
      <div class="chart">
        <div class="chart-placeholder">Category distribution chart will appear here</div>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Monthly Trend</div>
      <div class="chart">
        <div class="chart-placeholder">Monthly trend chart will appear here</div>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Approval Status</div>
      <div class="chart">
        <div class="chart-placeholder">Approval status chart will appear here</div>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Top Employees</div>
      <div class="chart">
        <div class="chart-placeholder">Top employees chart will appear here</div>
      </div>
    </div>
  </div>
</div>

<!-- Expenses Tab -->
<div id="expenses" class="tab-content">
  <div class="table-container">
    <h3>Expense Details</h3>
    <table id="expensesTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Employee</th>
          <th>Description</th>
          <th>Category</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody id="expensesTableBody">
        <!-- Expenses will be loaded here -->
      </tbody>
    </table>
    <div id="noExpenses" class="empty-state" style="display:none;">
      <div>No expenses found for the selected criteria</div>
    </div>
  </div>
</div>

<!-- Requests Tab -->
<div id="requests" class="tab-content">
  <div class="table-container">
    <h3>Expense Requests</h3>
    <table id="requestsTable">
      <thead>
        <tr>
          <th>Submitted</th>
          <th>Employee</th>
          <th>Description</th>
          <th>Category</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Approved/Declined By</th>
          <th>Decision Date</th>
        </tr>
      </thead>
      <tbody id="requestsTableBody">
        <!-- Requests will be loaded here -->
      </tbody>
    </table>
    <div id="noRequests" class="empty-state" style="display:none;">
      <div>No expense requests found for the selected criteria</div>
    </div>
  </div>
</div>

<!-- Admin Reports Tab -->
<div id="admin" class="tab-content">
  <div class="controls">
    <div class="control-group">
      <label for="adminReportType">Report Type</label>
      <select id="adminReportType">
        <option value="team">Team Performance</option>
        <option value="budget">Budget Utilization</option>
        <option value="approval">Approval Efficiency</option>
      </select>
    </div>
    <button class="btn" onclick="generateAdminReport()">Generate Admin Report</button>
  </div>
  
  <div class="table-container">
    <h3 id="adminReportTitle">Team Performance Report</h3>
    <table id="adminReportTable">
      <thead>
        <tr>
          <th>Team/Employee</th>
          <th>Total Expenses</th>
          <th>Approved Requests</th>
          <th>Pending Requests</th>
          <th>Declined Requests</th>
          <th>Avg. Approval Time</th>
        </tr>
      </thead>
      <tbody id="adminReportTableBody">
        <!-- Admin report data will be loaded here -->
      </tbody>
    </table>
    <div id="noAdminData" class="empty-state" style="display:none;">
      <div>No data available for admin report</div>
    </div>
  </div>
</div>

<!-- Export Section -->
<div class="export-section">
  <h3>Export Reports</h3>
  <p>Download your reports in various formats for offline analysis or sharing.</p>
  <div class="export-options">
    <button class="btn" onclick="exportReport('pdf')">Export as PDF</button>
    <button class="btn" onclick="exportReport('csv')">Export as CSV</button>
    <button class="btn" onclick="exportReport('excel')">Export as Excel</button>
  </div>
</div>

<script>
  // Global variables
  let currentUser = null;
  let allExpenses = [];
  let allRequests = [];
  let allUsers = [];

  // Initialize the page
  document.addEventListener('DOMContentLoaded', function() {
    // Check authentication and role
    currentUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!currentUser) {
      alert('Please login first.');
      window.location.href = 'index.html';
      return;
    }
    
    if (currentUser.role !== 'admin' && currentUser.role !== 'manager') {
      alert('Access denied: You do not have permission to view reports.');
      window.location.href = 'employee_dashboard.html';
      return;
    }
    
    // Update UI based on user role
    document.getElementById('userDisplay').textContent = `Welcome, ${currentUser.name || currentUser.username}`;
    
    if (currentUser.role === 'admin') {
      document.getElementById('adminTab').style.display = 'block';
      document.getElementById('employeeFilterGroup').style.display = 'flex';
      loadEmployeeFilter();
    } else if (currentUser.role === 'manager') {
      document.getElementById('employeeFilterGroup').style.display = 'flex';
      loadEmployeeFilter();
    }
    
    // Set default dates
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    
    document.getElementById('endDate').valueAsDate = endDate;
    document.getElementById('startDate').valueAsDate = startDate;
    
    // Load data and generate initial report
    loadData();
    generateReport();
  });

  // Load data from localStorage
  function loadData() {
    allExpenses = JSON.parse(localStorage.getItem('expenses')) || [];
    allRequests = JSON.parse(localStorage.getItem('expenseRequests')) || [];
    allUsers = JSON.parse(localStorage.getItem('users')) || [];
  }

  // Load employee filter options
  function loadEmployeeFilter() {
    const employeeFilter = document.getElementById('employeeFilter');
    employeeFilter.innerHTML = '<option value="all">All Employees</option>';
    
    if (currentUser.role === 'admin') {
      // Show all employees for admin
      allUsers.forEach(user => {
        if (user.role === 'employee') {
          employeeFilter.innerHTML += `<option value="${user.id}">${user.name || user.username}</option>`;
        }
      });
    } else if (currentUser.role === 'manager') {
      // Show only team members for manager
      // This would need team assignment data from localStorage
      const teamAssignments = JSON.parse(localStorage.getItem('teamAssignments')) || {};
      const myTeam = teamAssignments[currentUser.id] || [];
      
      allUsers.forEach(user => {
        if (myTeam.includes(user.id)) {
          employeeFilter.innerHTML += `<option value="${user.id}">${user.name || user.username}</option>`;
        }
      });
    }
  }

  // Tab switching
  function switchTab(tabName) {
    // Update tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.classList.remove('active');
    });
    document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
    
    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    document.getElementById(tabName).classList.add('active');
  }

  // Generate report based on filters
  function generateReport() {
    loadData();
    
    // Get filter values
    const timeRange = document.getElementById('timeRange').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const employeeFilter = document.getElementById('employeeFilter') ? 
                          document.getElementById('employeeFilter').value : 'all';
    
    let startDate, endDate;
    
    if (timeRange === 'custom') {
      startDate = new Date(document.getElementById('startDate').value);
      endDate = new Date(document.getElementById('endDate').value);
    } else {
      endDate = new Date();
      startDate = new Date();
      startDate.setDate(startDate.getDate() - parseInt(timeRange));
    }
    
    // Update report period display
    document.getElementById('reportPeriod').textContent = 
      `Report Period: ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`;
    
    // Filter expenses and requests
    const filteredExpenses = filterExpenses(startDate, endDate, categoryFilter, employeeFilter);
    const filteredRequests = filterRequests(startDate, endDate, categoryFilter, employeeFilter);
    
    // Update statistics
    updateStatistics(filteredExpenses, filteredRequests);
    
    // Update tables
    updateExpensesTable(filteredExpenses);
    updateRequestsTable(filteredRequests);
  }

  // Filter expenses based on criteria
  function filterExpenses(startDate, endDate, category, employee) {
    return allExpenses.filter(expense => {
      const expenseDate = new Date(expense.date);
      const categoryMatch = category === 'all' || expense.category === category;
      const employeeMatch = employee === 'all' || expense.userId === employee;
      const dateMatch = expenseDate >= startDate && expenseDate <= endDate;
      
      return categoryMatch && employeeMatch && dateMatch;
    });
  }

  // Filter requests based on criteria
  function filterRequests(startDate, endDate, category, employee) {
    return allRequests.filter(request => {
      const requestDate = new Date(request.submittedDate);
      const categoryMatch = category === 'all' || request.category === category;
      const employeeMatch = employee === 'all' || request.employeeId === employee;
      const dateMatch = requestDate >= startDate && requestDate <= endDate;
      
      return categoryMatch && employeeMatch && dateMatch;
    });
  }

  // Update statistics cards
  function updateStatistics(expenses, requests) {
    // Calculate totals
    const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
    const approvedRequests = requests.filter(req => req.status === 'approved').length;
    const pendingRequests = requests.filter(req => req.status === 'pending').length;
    const declinedRequests = requests.filter(req => req.status === 'declined').length;
    
    // Update UI
    document.getElementById('totalExpenses').textContent = `$${totalExpenses.toFixed(2)}`;
    document.getElementById('approvedRequests').textContent = approvedRequests;
    document.getElementById('pendingRequests').textContent = pendingRequests;
    document.getElementById('declinedRequests').textContent = declinedRequests;
  }

  // Update expenses table
  function updateExpensesTable(expenses) {
    const tbody = document.getElementById('expensesTableBody');
    const noExpenses = document.getElementById('noExpenses');
    
    if (expenses.length === 0) {
      tbody.innerHTML = '';
      noExpenses.style.display = 'block';
      return;
    }
    
    noExpenses.style.display = 'none';
    
    let html = '';
    expenses.forEach(expense => {
      const user = allUsers.find(u => u.id === expense.userId) || {};
      html += `
        <tr>
          <td>${expense.date}</td>
          <td>${user.name || user.username || 'Unknown'}</td>
          <td>${expense.title}</td>
          <td>${expense.category}</td>
          <td>$${expense.amount.toFixed(2)}</td>
        </tr>
      `;
    });
    
    tbody.innerHTML = html;
  }

  // Update requests table
  function updateRequestsTable(requests) {
    const tbody = document.getElementById('requestsTableBody');
    const noRequests = document.getElementById('noRequests');
    
    if (requests.length === 0) {
      tbody.innerHTML = '';
      noRequests.style.display = 'block';
      return;
    }
    
    noRequests.style.display = 'none';
    
    let html = '';
    requests.forEach(request => {
      let statusClass = 'status-pending';
      if (request.status === 'approved') statusClass = 'status-approved';
      if (request.status === 'declined') statusClass = 'status-declined';
      
      const approvedBy = request.status === 'approved' ? request.approvedBy : 
                        request.status === 'declined' ? request.declinedBy : 'N/A';
      
      html += `
        <tr>
          <td>${request.submittedDate}</td>
          <td>${request.employeeName}</td>
          <td>${request.title}</td>
          <td>${request.category}</td>
          <td>$${request.amount.toFixed(2)}</td>
          <td><span class="status-badge ${statusClass}">${request.status}</span></td>
          <td>${approvedBy}</td>
          <td>${request.decisionDate || 'N/A'}</td>
        </tr>
      `;
    });
    
    tbody.innerHTML = html;
  }

  // Generate admin report
  function generateAdminReport() {
    const reportType = document.getElementById('adminReportType').value;
    const tbody = document.getElementById('adminReportTableBody');
    const noAdminData = document.getElementById('noAdminData');
    const reportTitle = document.getElementById('adminReportTitle');
    
    // This is a simplified example - in a real app, you would have more complex logic
    let html = '';
    
    if (reportType === 'team') {
      reportTitle.textContent = 'Team Performance Report';
      
      // Group requests by employee
      const employeeStats = {};
      allRequests.forEach(request => {
        if (!employeeStats[request.employeeId]) {
          employeeStats[request.employeeId] = {
            name: request.employeeName,
            total: 0,
            approved: 0,
            pending: 0,
            declined: 0,
            totalAmount: 0
          };
        }
        
        employeeStats[request.employeeId].total++;
        employeeStats[request.employeeId].totalAmount += request.amount;
        
        if (request.status === 'approved') employeeStats[request.employeeId].approved++;
        if (request.status === 'pending') employeeStats[request.employeeId].pending++;
        if (request.status === 'declined') employeeStats[request.employeeId].declined++;
      });
      
      // Generate table rows
      for (const employeeId in employeeStats) {
        const stats = employeeStats[employeeId];
        html += `
          <tr>
            <td>${stats.name}</td>
            <td>$${stats.totalAmount.toFixed(2)}</td>
            <td>${stats.approved}</td>
            <td>${stats.pending}</td>
            <td>${stats.declined}</td>
            <td>2.5 days</td>
          </tr>
        `;
      }
    }
    
    if (html === '') {
      tbody.innerHTML = '';
      noAdminData.style.display = 'block';
    } else {
      tbody.innerHTML = html;
      noAdminData.style.display = 'none';
    }
  }

  // Reset filters
  function resetFilters() {
    document.getElementById('timeRange').value = '30';
    document.getElementById('categoryFilter').value = 'all';
    
    if (document.getElementById('employeeFilter')) {
      document.getElementById('employeeFilter').value = 'all';
    }
    
    document.getElementById('customRangeGroup').style.display = 'none';
    document.getElementById('customRangeGroup2').style.display = 'none';
    
    generateReport();
  }

  // Export report
  function exportReport(format) {
    alert(`Exporting report as ${format.toUpperCase()}...\n\nIn a real application, this would generate and download a ${format} file with the current report data.`);
    // In a real application, you would implement actual export functionality here
  }

  // Logout function
  function logout() {
    localStorage.removeItem('loggedInUser');
    alert('Logged out successfully.');
    window.location.href = 'index.html';
  }

  // Show/hide custom date range
  document.getElementById('timeRange').addEventListener('change', function() {
    const isCustom = this.value === 'custom';
    document.getElementById('customRangeGroup').style.display = isCustom ? 'flex' : 'none';
    document.getElementById('customRangeGroup2').style.display = isCustom ? 'flex' : 'none';
  });
</script>
</body>
</html>