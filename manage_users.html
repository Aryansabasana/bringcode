<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>User Management - ExpenseEase</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
  /* Reset & Base Styles */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  body {
    font-family: 'Montserrat', sans-serif;
    line-height: 1.6;
    background-color: #f0f4f8;
    color: #333;
    padding: 20px;
  }

  /* Header */
  .header {
    background-color: #4CAF50;
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .logo {
    font-size: 1.5em;
    font-weight: 700;
    color: #fff;
    letter-spacing: 1px;
  }
  .user-info {
    color: #fff;
    font-weight: 500;
  }
  .logout-btn {
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s;
  }
  .logout-btn:hover {
    background: rgba(255,255,255,0.3);
  }

  /* Page Title */
  .page-title {
    color: #4CAF50;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .page-title h2 {
    font-size: 1.8em;
  }

  /* Stats Cards */
  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }
  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    text-align: center;
  }
  .stat-value {
    font-size: 1.8em;
    font-weight: 700;
    margin: 10px 0;
  }
  .stat-label {
    color: #666;
    font-weight: 500;
  }
  .stat-total { border-top: 4px solid #4CAF50; }
  .stat-employee { border-top: 4px solid #2196F3; }
  .stat-manager { border-top: 4px solid #FF9800; }
  .stat-admin { border-top: 4px solid #F44336; }

  /* Controls */
  .controls {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: end;
  }
  .control-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
  }
  .control-group label {
    font-weight: 600;
    margin-bottom: 5px;
    color: #555;
  }
  .control-group select, .control-group input {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-family: 'Montserrat', sans-serif;
  }
  .btn {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s;
  }
  .btn:hover {
    background-color: #45a049;
  }
  .btn-secondary {
    background-color: #2196F3;
  }
  .btn-secondary:hover {
    background-color: #1976D2;
  }
  .btn-danger {
    background-color: #f44336;
  }
  .btn-danger:hover {
    background-color: #d32f2f;
  }

  /* Tables */
  .table-container {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 12px 15px;
    text-align: left;
  }
  th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #495057;
  }
  tr:nth-child(even) {
    background-color: #f8f9fa;
  }
  .role-badge {
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
  }
  .role-employee {
    background-color: #e3f2fd;
    color: #1976D2;
  }
  .role-manager {
    background-color: #fff3e0;
    color: #F57C00;
  }
  .role-admin {
    background-color: #ffebee;
    color: #d32f2f;
  }
  .action-buttons {
    display: flex;
    gap: 5px;
  }
  .action-btn {
    padding: 5px 10px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8em;
    transition: background-color 0.3s;
  }
  .edit-btn {
    background-color: #FFC107;
    color: #000;
  }
  .edit-btn:hover {
    background-color: #FFA000;
  }
  .delete-btn {
    background-color: #f44336;
    color: white;
  }
  .delete-btn:hover {
    background-color: #d32f2f;
  }

  /* Modal Styles */
  .modal {
    display: none; 
    position: fixed; 
    z-index: 1000; 
    left: 0;
    top: 0;
    width: 100%; 
    height: 100%; 
    overflow: auto; 
    background-color: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
  }
  .modal-content {
    background-color: #fff;
    padding: 30px;
    border-radius: 10px;
    max-width: 500px;
    width: 90%;
    position: relative;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }
  .close-btn {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 1.5em;
    cursor: pointer;
    color: #555;
  }
  .form-group {
    margin-bottom: 15px;
  }
  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #555;
  }
  .form-group input, .form-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-family: 'Montserrat', sans-serif;
  }
  .modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
  }

  /* Access Denied */
  .access-denied {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  .access-denied h2 {
    color: #dc3545;
    margin-bottom: 15px;
  }
  .access-denied p {
    color: #666;
    margin-bottom: 20px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .controls {
      flex-direction: column;
      align-items: stretch;
    }
    .control-group {
      width: 100%;
    }
    .stats-container {
      grid-template-columns: 1fr;
    }
    .action-buttons {
      flex-direction: column;
    }
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="logo">ExpenseEase - User Management</div>
  <div class="user-info">
    <span id="userDisplay">Welcome, Admin</span>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</div>

<!-- Page Title -->
<div class="page-title">
  <h2>User Management</h2>
  <button class="btn" onclick="openAddUserModal()">Add New User</button>
</div>

<!-- Main Content -->
<div id="mainContent">
  <!-- This will be populated based on user role -->
</div>

<!-- Add/Edit User Modal -->
<div id="userModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeUserModal">&times;</span>
    <h3 id="modalTitle">Add New User</h3>
    <form id="userForm">
      <input type="hidden" id="editUserId">
      <div class="form-group">
        <label for="userName">Full Name</label>
        <input type="text" id="userName" placeholder="Enter full name" required>
      </div>
      <div class="form-group">
        <label for="userUsername">Username</label>
        <input type="text" id="userUsername" placeholder="Enter username" required>
      </div>
      <div class="form-group">
        <label for="userEmail">Email</label>
        <input type="email" id="userEmail" placeholder="Enter email" required>
      </div>
      <div class="form-group">
        <label for="userPassword">Password</label>
        <input type="password" id="userPassword" placeholder="Enter password" required>
        <small style="color: #666;">Leave blank to keep current password when editing</small>
      </div>
      <div class="form-group">
        <label for="userRole">Role</label>
        <select id="userRole" required>
          <option value="">Select Role</option>
          <option value="employee">Employee</option>
          <option value="manager">Manager</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="form-group">
        <label for="userDepartment">Department (Optional)</label>
        <input type="text" id="userDepartment" placeholder="Enter department">
      </div>
      <div class="modal-buttons">
        <button type="submit" class="btn" id="modalSubmitBtn">Add User</button>
        <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeDeleteModal">&times;</span>
    <h3>Confirm Deletion</h3>
    <p id="deleteMessage">Are you sure you want to delete this user?</p>
    <div class="modal-buttons">
      <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
      <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
  // Global variables
  let currentUser = null;
  let allUsers = [];
  let userToDelete = null;

  // Initialize the page
  document.addEventListener('DOMContentLoaded', function() {
    // Check authentication and role
    currentUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!currentUser) {
      showAccessDenied('Please login first.');
      return;
    }
    
    // Only allow admin access
    if (currentUser.role !== 'admin') {
      showAccessDenied('Access denied: Only administrators can manage users.');
      return;
    }
    
    // Update UI based on user role
    document.getElementById('userDisplay').textContent = `Welcome, ${currentUser.name || currentUser.username} (Admin)`;
    
    // Load data and generate initial view
    loadData();
    initializeUserManagementView();
  });

  // Load data from localStorage
  function loadData() {
    allUsers = JSON.parse(localStorage.getItem('users')) || [];
  }

  // Initialize user management view
  function initializeUserManagementView() {
    const mainContent = document.getElementById('mainContent');
    
    // Create stats cards
    const statsHTML = `
      <div class="stats-container">
        <div class="stat-card stat-total">
          <div class="stat-label">Total Users</div>
          <div class="stat-value" id="totalUsers">0</div>
          <div>All Users</div>
        </div>
        <div class="stat-card stat-employee">
          <div class="stat-label">Employees</div>
          <div class="stat-value" id="employeeUsers">0</div>
          <div>Regular Users</div>
        </div>
        <div class="stat-card stat-manager">
          <div class="stat-label">Managers</div>
          <div class="stat-value" id="managerUsers">0</div>
          <div>Team Leaders</div>
        </div>
        <div class="stat-card stat-admin">
          <div class="stat-label">Admins</div>
          <div class="stat-value" id="adminUsers">0</div>
          <div>System Administrators</div>
        </div>
      </div>
    `;

    // Create controls
    const controlsHTML = `
      <div class="controls">
        <div class="control-group">
          <label for="roleFilter">Filter by Role</label>
          <select id="roleFilter">
            <option value="all">All Roles</option>
            <option value="employee">Employee</option>
            <option value="manager">Manager</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="control-group">
          <label for="searchUser">Search Users</label>
          <input type="text" id="searchUser" placeholder="Search by name or username">
        </div>
        <button class="btn" onclick="filterUsers()">Apply Filters</button>
        <button class="btn btn-secondary" onclick="resetFilters()">Reset Filters</button>
      </div>
    `;

    // Create users table
    const usersHTML = `
      <div class="table-container">
        <h3>System Users</h3>
        <table id="usersTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Department</th>
              <th>Join Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <!-- Users will be loaded here -->
          </tbody>
        </table>
        <div id="noUsers" class="empty-state" style="display:none;">
          <div>No users found for the selected criteria</div>
        </div>
      </div>
    `;

    mainContent.innerHTML = statsHTML + controlsHTML + usersHTML;
    
    // Load users data
    loadUsersTable();
  }

  // Load users table with data
  function loadUsersTable() {
    const roleFilter = document.getElementById('roleFilter').value;
    const searchTerm = document.getElementById('searchUser').value.toLowerCase();
    
    // Filter users
    let filteredUsers = allUsers.filter(user => {
      const roleMatch = roleFilter === 'all' || user.role === roleFilter;
      const searchMatch = !searchTerm || 
        (user.name && user.name.toLowerCase().includes(searchTerm)) ||
        (user.username && user.username.toLowerCase().includes(searchTerm)) ||
        (user.email && user.email.toLowerCase().includes(searchTerm));
      
      return roleMatch && searchMatch;
    });

    // Update statistics
    updateUserStatistics(filteredUsers);
    
    // Update table
    updateUsersTable(filteredUsers);
  }

  // Update user statistics
  function updateUserStatistics(users) {
    const totalUsers = users.length;
    const employeeUsers = users.filter(user => user.role === 'employee').length;
    const managerUsers = users.filter(user => user.role === 'manager').length;
    const adminUsers = users.filter(user => user.role === 'admin').length;
    
    document.getElementById('totalUsers').textContent = totalUsers;
    document.getElementById('employeeUsers').textContent = employeeUsers;
    document.getElementById('managerUsers').textContent = managerUsers;
    document.getElementById('adminUsers').textContent = adminUsers;
  }

  // Update users table
  function updateUsersTable(users) {
    const tbody = document.getElementById('usersTableBody');
    const noUsers = document.getElementById('noUsers');
    
    if (users.length === 0) {
      tbody.innerHTML = '';
      noUsers.style.display = 'block';
      return;
    }
    
    noUsers.style.display = 'none';
    
    let html = '';
    users.forEach(user => {
      let roleClass = 'role-employee';
      if (user.role === 'manager') roleClass = 'role-manager';
      if (user.role === 'admin') roleClass = 'role-admin';
      
      // Don't allow deleting the current user
      const canDelete = user.id !== currentUser.id;
      
      html += `
        <tr>
          <td>${user.name || 'N/A'}</td>
          <td>${user.username}</td>
          <td>${user.email || 'N/A'}</td>
          <td><span class="role-badge ${roleClass}">${user.role}</span></td>
          <td>${user.department || 'N/A'}</td>
          <td>${user.joinDate || 'N/A'}</td>
          <td>
            <div class="action-buttons">
              <button class="action-btn edit-btn" onclick="editUser('${user.id}')">Edit</button>
              ${canDelete ? `<button class="action-btn delete-btn" onclick="deleteUser('${user.id}')">Delete</button>` : ''}
            </div>
          </td>
        </tr>
      `;
    });
    
    tbody.innerHTML = html;
  }

  // Filter users
  function filterUsers() {
    loadUsersTable();
  }

  // Reset filters
  function resetFilters() {
    document.getElementById('roleFilter').value = 'all';
    document.getElementById('searchUser').value = '';
    loadUsersTable();
  }

  // Open add user modal
  function openAddUserModal() {
    document.getElementById('modalTitle').textContent = 'Add New User';
    document.getElementById('modalSubmitBtn').textContent = 'Add User';
    document.getElementById('userForm').reset();
    document.getElementById('editUserId').value = '';
    document.getElementById('userModal').style.display = 'flex';
  }

  // Close user modal
  function closeUserModal() {
    document.getElementById('userModal').style.display = 'none';
  }

  // Edit user
  function editUser(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;
    
    document.getElementById('modalTitle').textContent = 'Edit User';
    document.getElementById('modalSubmitBtn').textContent = 'Update User';
    document.getElementById('editUserId').value = user.id;
    document.getElementById('userName').value = user.name || '';
    document.getElementById('userUsername').value = user.username;
    document.getElementById('userEmail').value = user.email || '';
    document.getElementById('userPassword').value = '';
    document.getElementById('userPassword').required = false;
    document.getElementById('userRole').value = user.role;
    document.getElementById('userDepartment').value = user.department || '';
    
    document.getElementById('userModal').style.display = 'flex';
  }

  // Handle user form submission
  document.getElementById('userForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const userId = document.getElementById('editUserId').value;
    const name = document.getElementById('userName').value.trim();
    const username = document.getElementById('userUsername').value.trim();
    const email = document.getElementById('userEmail').value.trim();
    const password = document.getElementById('userPassword').value;
    const role = document.getElementById('userRole').value;
    const department = document.getElementById('userDepartment').value.trim();
    
    // Validation
    if (!name || !username || !role) {
      alert('Please fill in all required fields.');
      return;
    }
    
    // Check if username already exists (for new users or when username changed)
    const existingUser = allUsers.find(u => u.username === username && u.id !== userId);
    if (existingUser) {
      alert('Username already exists. Please choose a different username.');
      return;
    }
    
    if (userId) {
      // Update existing user
      const userIndex = allUsers.findIndex(u => u.id === userId);
      if (userIndex !== -1) {
        allUsers[userIndex].name = name;
        allUsers[userIndex].username = username;
        allUsers[userIndex].email = email;
        allUsers[userIndex].role = role;
        allUsers[userIndex].department = department;
        
        // Only update password if provided
        if (password) {
          allUsers[userIndex].password = password;
        }
      }
    } else {
      // Add new user
      const newUser = {
        id: 'user' + Date.now(),
        name: name,
        username: username,
        email: email,
        password: password,
        role: role,
        department: department,
        joinDate: new Date().toISOString().split('T')[0]
      };
      allUsers.push(newUser);
    }
    
    // Save to localStorage
    localStorage.setItem('users', JSON.stringify(allUsers));
    
    // Reload table and close modal
    loadUsersTable();
    closeUserModal();
    
    alert(userId ? 'User updated successfully!' : 'User added successfully!');
  });

  // Delete user
  function deleteUser(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;
    
    // Check if user is trying to delete themselves
    if (userId === currentUser.id) {
      alert('You cannot delete your own account.');
      return;
    }
    
    userToDelete = userId;
    document.getElementById('deleteMessage').textContent = `Are you sure you want to delete user "${user.name || user.username}"? This action cannot be undone.`;
    document.getElementById('deleteModal').style.display = 'flex';
  }

  // Confirm deletion
  function confirmDelete() {
    if (!userToDelete) return;
    
    // Remove user from array
    allUsers = allUsers.filter(user => user.id !== userToDelete);
    
    // Save to localStorage
    localStorage.setItem('users', JSON.stringify(allUsers));
    
    // Reload table and close modal
    loadUsersTable();
    closeDeleteModal();
    
    alert('User deleted successfully!');
    userToDelete = null;
  }

  // Close delete modal
  function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    userToDelete = null;
  }

  // Show access denied message
  function showAccessDenied(message) {
    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = `
      <div class="access-denied">
        <h2>Access Denied</h2>
        <p>${message}</p>
        <button class="btn" onclick="goToLogin()">Go to Login</button>
      </div>
    `;
  }

  // Redirect to login
  function goToLogin() {
    window.location.href = 'login.html';
  }

  // Logout function
  function logout() {
    localStorage.removeItem('loggedInUser');
    alert('Logged out successfully.');
    window.location.href = 'index.html';
  }

  // Close modals when clicking outside
  window.onclick = function(event) {
    const userModal = document.getElementById('userModal');
    const deleteModal = document.getElementById('deleteModal');
    
    if (event.target === userModal) {
      closeUserModal();
    }
    if (event.target === deleteModal) {
      closeDeleteModal();
    }
  }

  // Close modals with close buttons
  document.getElementById('closeUserModal').addEventListener('click', closeUserModal);
  document.getElementById('closeDeleteModal').addEventListener('click', closeDeleteModal);
</script>
</body>
</html>